FROM python:2.7
WORKDIR /app
COPY requirements.txt gunicorn.conf db_app.py db_config.py /app/
COPY celery_app_config.py.example /app/celery_app_config.py
COPY ssh_config /home/appuser/.ssh/config
RUN groupadd appusers && \
    useradd appuser -G appusers && \
    chown -R appuser:appusers /app && \
    pip install -r requirements.txt && \
    chown -R appuser:appusers /home/appuser/.ssh && \ 
    chmod -R 700 /home/appuser/.ssh && \
    mkdir /instance && \
    touch /instance/db_config.py
USER appuser:appusers
EXPOSE 4002
ENTRYPOINT ["/usr/local/bin/gunicorn", "--config", "/app/gunicorn.conf", "-b", ":4002", "db_app:app"]